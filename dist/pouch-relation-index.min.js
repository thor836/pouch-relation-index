!function e(t,r,n){function o(u,a){if(!r[u]){if(!t[u]){var s="function"==typeof require&&require;if(!a&&s)return s(u,!0);if(i)return i(u,!0);var c=new Error("Cannot find module '"+u+"'");throw c.code="MODULE_NOT_FOUND",c}var f=r[u]={exports:{}};t[u][0].call(f.exports,function(e){var r=t[u][1][e];return o(r||e)},f,f.exports,e,t,r,n)}return r[u].exports}for(var i="function"==typeof require&&require,u=0;u<n.length;u++)o(n[u]);return o}({1:[function(e,t,r){"use strict";function n(e,t,r){var n=r[r.length-1];e===n.element&&(r.pop(),n=r[r.length-1]);var o=n.element,i=n.index;if(Array.isArray(o))o.push(e);else if(i===t.length-2){var u=t.pop();o[u]=e}else t.push(e)}r.stringify=function(e){var t=[];t.push({obj:e});for(var r,n,o,i,u,a,s,c,f,l,p,d="";r=t.pop();)if(n=r.obj,o=r.prefix||"",i=r.val||"",d+=o,i)d+=i;else if("object"!=typeof n)d+=void 0===n?null:JSON.stringify(n);else if(null===n)d+="null";else if(Array.isArray(n)){for(t.push({val:"]"}),u=n.length-1;u>=0;u--)a=0===u?"":",",t.push({obj:n[u],prefix:a});t.push({val:"["})}else{s=[];for(c in n)n.hasOwnProperty(c)&&s.push(c);for(t.push({val:"}"}),u=s.length-1;u>=0;u--)f=s[u],l=n[f],p=u>0?",":"",p+=JSON.stringify(f)+":",t.push({obj:l,prefix:p});t.push({val:"{"})}return d},r.parse=function(e){for(var t,r,o,i,u,a,s,c,f,l=[],p=[],d=0;;)if("}"!==(t=e[d++])&&"]"!==t&&void 0!==t)switch(t){case" ":case"\t":case"\n":case":":case",":break;case"n":d+=3,n(null,l,p);break;case"t":d+=3,n(!0,l,p);break;case"f":d+=4,n(!1,l,p);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(r="",d--;;){if(o=e[d++],!/[\d\.\-e\+]/.test(o)){d--;break}r+=o}n(parseFloat(r),l,p);break;case'"':for(i="",u=void 0,a=0;;){if('"'===(s=e[d++])&&("\\"!==u||a%2!=1))break;i+=s,u=s,"\\"===u?a++:a=0}n(JSON.parse('"'+i+'"'),l,p);break;case"[":c={element:[],index:l.length},l.push(c.element),p.push(c);break;case"{":f={element:{},index:l.length},l.push(f.element),p.push(f);break;default:throw new Error("unexpectedly reached end of input: "+t)}else{if(1===l.length)return l.pop();n(l.pop(),l,p)}}},{}],2:[function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(r,"__esModule",{value:!0});var o=function(e){function t(t){return e.call(this,"Index "+t+" already exists")||this}return n(t,e),t}(Error);r.default=o},{}],3:[function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(r,"__esModule",{value:!0});var o=function(e){function t(t){var r=e.call(this,"Index "+t+" could not be found")||this;return r.status=404,r}return n(t,e),t}(Error);r.default=o},{}],4:[function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(r,"__esModule",{value:!0});var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t}(Error);r.default=o},{}],5:[function(e,t,r){"use strict";var n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(r,"__esModule",{value:!0});var o=e("./webSqlProvider"),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.batchSql=function(t){var r=this;return new Promise(function(n,o){var i=r.openConnection();"function"==typeof i.sqlBatch?i.sqlBatch(t,n,o):e.prototype.batchSql.call(r,t).then(n).catch(o)})},t.prototype.openConnection=function(){return window.sqlitePlugin.openDatabase({name:this.db,version:1,description:this.db,size:5e6})},t}(o.default);r.default=i},{"./webSqlProvider":6}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("../utils"),o=function(){function e(e){this.db=e}return e.prototype.executeSql=function(e,t){var r=this;return void 0===t&&(t=[]),new Promise(function(n,o){r.openConnection().transaction(function(r){return r.executeSql(e,t||[],function(e,t){return n(t)},function(e,t){return o(t),!0})},function(e){return o(e)})})},e.prototype.batchSql=function(e){var t=this;return new Promise(function(r,o){t.openConnection().transaction(function(t){return n.default.eachAsync(e,function(e,r){return t.executeSql(e[0],e[1],r,function(e,t){return r(t)})},function(e){return e?o(e):r()})},o)})},e.prototype.openConnection=function(){return window.openDatabase(this.db,"1","",5e6)},e}();r.default=o},{"../utils":9}],7:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./utils"),o=e("./errors/selectorError"),i=function(){function e(){}return e.query=function(t,r){var n=[];return{where:e.parseObject(t,r,n),args:n}},e.parseObject=function(t,r,n){var i=[];for(var u in t)if(t.hasOwnProperty(u)){var a=t[u];if(["$or","$and"].indexOf(u)>-1&&!Array.isArray(a))throw new o.default("Use of $and, $or operator requires an array as its parameter.");switch(i.length&&i.push(" AND "),u){case"$or":var s=a.map(function(t){return e.parseObject(t,r,n)});s.length&&i.push("("+s.join(" OR ")+")");break;case"$and":s=a.map(function(t){return e.parseObject(t,r,n)}),s.length&&i.push("("+s.join(" AND ")+")");break;default:i.push(e.parseSingleKeyValue(u,a,r,n))}}return i.join("")},e.parseSingleKeyValue=function(t,r,i,u){var a=e.operators[t]||("object"!=typeof r?e.operators.$eq:null);if(a){var s=n.default.wrap(i)+"."+n.default.wrap(t)+" "+a;if("$in"==t||"$nin"==t){if(!Array.isArray(r))throw new o.default("Use of $in, $nin operator requires an array as its parameter.");return u.concat(r),s+" ["+Array(r.length).fill("?").join()+"]"}return u.push("string"==typeof r?r.toLowerCase():r),s+" ?"}return n.default.wrap(i)+"."+n.default.wrap(t)+" "+e.parseObject(r,i,u)},e}();i.operators={$eq:"=",$lt:"<",$gt:">",$lte:"<=",$gte:">=",$ne:"!=",$in:"IN",$nin:"NOT IN",$like:"LIKE"},r.default=i},{"./errors/selectorError":4,"./utils":9}],8:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./errors/indexNotFoundError"),o=e("./utils"),i=e("./errors/indexExistsError"),u=e("./providers/sqliteProvider"),a=e("./providers/webSqlProvider"),s=e("./queryBuilder"),c=function(){function e(e,t){this.db=e,this.provider=t,this._init=!1,this.indexes={}}return e.prototype.info=function(e){var t=this.indexes[e];return t?Promise.resolve(t):Promise.reject(new n.default(e))},e.prototype.create=function(e){var t=this;return this.indexes[e.name]?Promise.reject(new i.default(e.name)):this.createTable("_ri_"+e.name,[{name:"id",type:"TEXT",primary_key:!0},{name:"rev",type:"TEXT"}].concat(e.fields.map(function(e){return{name:e.name||e+"",type:e.type||"TEXT"}}))).then(function(){return t.provider.executeSql("INSERT INTO "+o.default.wrap("relation-indexes")+" VALUES (?,?,?)",[e.name,e.doc_type,JSON.stringify(e.fields)])}).then(function(){t.indexes[e.name]=e})},e.prototype.build=function(e){var t=this,r=this.indexes[e];if(!r)return Promise.reject(new n.default(e));var i=o.default.wrap("_ri_"+e);return this.provider.executeSql("DELETE FROM "+i).then(function(){return t.fillIndexTable(r)})},e.prototype.query=function(e,t,r,i){void 0===i&&(i=!0);var u=this.indexes[e];if(!u)return Promise.reject(new n.default(e));var a,c=o.default.wrap("_ri_"+e),f=t?s.default.query(t,"_ri_"+e):null,l=r&&r.length?r.map(function(e){return c+"."+o.default.wrap(e.field||e+"")+" "+(e.dir||"ASC")}).join():"";if(i)a="\n            SELECT\n                `document-store`.id AS id,\n                `by-sequence`.rev AS rev,\n                `by-sequence`.json AS data \n            FROM `document-store` \n                JOIN `by-sequence` ON `by-sequence`.seq = `document-store`.winningseq \n                JOIN "+c+" ON `document-store`.id = "+c+".id \n            WHERE \n                "+(f.where?f.where+" AND ":"")+" \n                `by-sequence`.deleted = 0 \n            ORDER BY "+(l?l+",":"")+" `document-store`.id ASC";else{a="SELECT "+u.fields.map(function(e){return c+o.default.wrap(e.name)}).join()+" FROM "+c+" WHERE "+(f.where?f.where+" AND ":"")+" 1 = 1 "+(l?"ORDER BY "+l+",":"")}return this.provider.executeSql(a,f.args).then(function(e){for(var t=[],r=0;r<e.rows.length;r++){var n=e.rows.item(r);t.push(o.default.unstringifyDoc(n.data,n.id,n.rev))}return t})},e.prototype.remove=function(e){var t=this;if(!this.indexes[e])return Promise.reject(new n.default(e));var r=o.default.wrap("_ri_"+e);return this.provider.executeSql("DELETE FROM "+o.default.wrap("relation-indexes")+" WHERE index_name = ?",[e]).then(function(){return t.provider.executeSql("DROP TABLE IF EXISTS "+r)})},e.prototype.update=function(e){var t=this,r=this.indexes[e];if(!r)return Promise.reject(new n.default(e));var i=o.default.wrap("_ri_"+e),u=r.doc_type.length,a=["_id","_rev"].concat(r.fields.map(function(e){return e.name})),s=Array(a.length).fill("?"),c="\n        SELECT \n            `document-store`.id AS id, \n            `by-sequence`.rev AS rev, \n            `by-sequence`.json AS data \n        FROM `document-store` \n            JOIN `by-sequence` ON `by-sequence`.seq = `document-store`.winningseq  \n        WHERE \n            NOT EXISTS(SELECT 1 FROM "+i+" WHERE `document-store`.id = "+i+".id )  \n            AND \n            substr(`document-store`.id, 1, "+u+") = ?  \n            AND \n            `by-sequence`.deleted = 0";this.provider.executeSql(c,[r.doc_type]).then(function(e){for(var r=[],n=0;n<e.rows.length;n++){var u=e.rows.item(n);r.push(o.default.unstringifyDoc(u.data,u.id,u.rev))}if(r.length){var c=r.map(function(e){var t=a.map(function(t){var r=o.default.resolve(e.doc,t);return"string"==typeof r?r.toLowerCase():r});return["INSERT INTO "+i+" VALUES ("+s+")",t]});return t.provider.batchSql(c)}})},e.prototype.init=function(){var e=this;return this._init?Promise.resolve(null):this.createTable("relation-indexes",[{name:"index_name",type:"TEXT"},{name:"doc_type",type:"TEXT"},{name:"json",type:"TEXT"}]).then(function(){return e.getIndexes()}).then(function(){e._init=!0})},e.prototype.getIndexes=function(){var e=this;return this.provider.executeSql("SELECT * FROM "+o.default.wrap("relation-indexes")).then(function(t){for(var r=0;r<t.rows.length;r++){var n=t.rows.item(r);e.indexes[n.index_name]={name:n.index_name,doc_type:n.doc_type,fields:JSON.parse(n.json)}}})},e.prototype.createTable=function(e,t){return this.provider.executeSql("CREATE TABLE IF NOT EXISTS "+o.default.wrap(e)+" ("+o.default.fieldsToSql(t)+")").then(function(){})},e.prototype.fillIndexTable=function(e,t){var r=this;void 0===t&&(t=0);var n=o.default.wrap("_ri_"+e.name),i=["_id","_rev"].concat(e.fields.map(function(e){return e.name})),u=Array(i.length).fill("?");return this.db.allDocs({startkey:e.doc_type,endkey:e.doc_type+"ï¿¿",include_docs:!0,skip:t,limit:1e3}).then(function(a){var s=a.rows.length;if(s){var c=a.rows.map(function(e){var t=i.map(function(t){var r=o.default.resolve(e.doc,t);return"string"==typeof r?r.toLowerCase():r});return["INSERT INTO "+n+" VALUES ("+u+")",t]});return r.provider.batchSql(c).then(function(){if(1e3===s)return r.fillIndexTable(e,t+1e3)})}})},e}();r.RelationIndex=c,"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin({initRelationIndex:function(){var e=this;if(!e.relIndex){var t;if("cordova-sqlite"===e.adapter&&window.sqlitePlugin)t=new u.default(e.prefix+e.name);else{if("websql"!==e.adapter)throw new Error("Relation Index plugin supports only websql or cordova-sqlite adapters");t=new a.default(e.prefix+e.name)}return e.relIndex=new c(e,t),e.relIndex.init()}}})},{"./errors/indexExistsError":2,"./errors/indexNotFoundError":3,"./providers/sqliteProvider":5,"./providers/webSqlProvider":6,"./queryBuilder":7,"./utils":9}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("vuvuzela"),o=function(){function e(){}return e.wrap=function(e){return Array.isArray(e)?e.map(function(e){return"`"+e+"`"}).join():"`"+e+"`"},e.fieldsToSql=function(t){return t.map(function(t){return e.wrap(t.name)+" "+t.type+" "+(t.primary_key?"NOT NULL PRIMARY KEY":"")}).join()},e.resolve=function(e,t,r){return void 0===r&&(r=null),t.split(".").reduce(function(e,t){return e&&e[t]},e)||r},e.eachAsync=function(e,t,r){var n=0,o=e.length,i=function(u){!u&&n<o?(t(e[n],i),n++):"function"==typeof r&&r(u)};i()},e.unstringifyDoc=function(t,r,n){return t=e.safeJsonParse(t),t._id=r,t._rev=n,t},e.safeJsonParse=function(e){try{return JSON.parse(e)}catch(t){return n.default.parse(e)}},e}();r.default=o},{vuvuzela:1}]},{},[8]);
