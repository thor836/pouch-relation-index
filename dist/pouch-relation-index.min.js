!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.pouchRelationIndex=e()}}(function(){return function e(t,n,r){function o(u,a){if(!n[u]){if(!t[u]){var s="function"==typeof require&&require;if(!a&&s)return s(u,!0);if(i)return i(u,!0);var c=new Error("Cannot find module '"+u+"'");throw c.code="MODULE_NOT_FOUND",c}var f=n[u]={exports:{}};t[u][0].call(f.exports,function(e){var n=t[u][1][e];return o(n||e)},f,f.exports,e,t,n,r)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<r.length;u++)o(r[u]);return o}({1:[function(e,t,n){"use strict";function r(e,t,n){var r=n[n.length-1];e===r.element&&(n.pop(),r=n[n.length-1]);var o=r.element,i=r.index;if(Array.isArray(o))o.push(e);else if(i===t.length-2){var u=t.pop();o[u]=e}else t.push(e)}n.stringify=function(e){var t=[];t.push({obj:e});for(var n,r,o,i,u,a,s,c,f,l,p,d="";n=t.pop();)if(r=n.obj,o=n.prefix||"",i=n.val||"",d+=o,i)d+=i;else if("object"!=typeof r)d+=void 0===r?null:JSON.stringify(r);else if(null===r)d+="null";else if(Array.isArray(r)){for(t.push({val:"]"}),u=r.length-1;u>=0;u--)a=0===u?"":",",t.push({obj:r[u],prefix:a});t.push({val:"["})}else{s=[];for(c in r)r.hasOwnProperty(c)&&s.push(c);for(t.push({val:"}"}),u=s.length-1;u>=0;u--)f=s[u],l=r[f],p=u>0?",":"",p+=JSON.stringify(f)+":",t.push({obj:l,prefix:p});t.push({val:"{"})}return d},n.parse=function(e){for(var t,n,o,i,u,a,s,c,f,l=[],p=[],d=0;;)if("}"!==(t=e[d++])&&"]"!==t&&void 0!==t)switch(t){case" ":case"\t":case"\n":case":":case",":break;case"n":d+=3,r(null,l,p);break;case"t":d+=3,r(!0,l,p);break;case"f":d+=4,r(!1,l,p);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(n="",d--;;){if(o=e[d++],!/[\d\.\-e\+]/.test(o)){d--;break}n+=o}r(parseFloat(n),l,p);break;case'"':for(i="",u=void 0,a=0;;){if('"'===(s=e[d++])&&("\\"!==u||a%2!=1))break;i+=s,u=s,"\\"===u?a++:a=0}r(JSON.parse('"'+i+'"'),l,p);break;case"[":c={element:[],index:l.length},l.push(c.element),p.push(c);break;case"{":f={element:{},index:l.length},l.push(f.element),p.push(f);break;default:throw new Error("unexpectedly reached end of input: "+t)}else{if(1===l.length)return l.pop();r(l.pop(),l,p)}}},{}],2:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(n,"__esModule",{value:!0});var o=function(e){function t(t){return e.call(this,"Index "+t+" already exists")||this}return r(t,e),t}(Error);n.default=o},{}],3:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(n,"__esModule",{value:!0});var o=function(e){function t(t){var n=e.call(this,"Index "+t+" could not be found")||this;return n.status=404,n}return r(t,e),t}(Error);n.default=o},{}],4:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(n,"__esModule",{value:!0});var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(Error);n.default=o},{}],5:[function(e,t,n){"use strict";var r=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(n,"__esModule",{value:!0});var o=e("./webSqlProvider"),i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype.batchSql=function(t){var n=this;return new Promise(function(r,o){var i=n.openConnection();"function"==typeof i.sqlBatch?i.sqlBatch(t,r,o):e.prototype.batchSql.call(n,t).then(r).catch(o)})},t.prototype.openConnection=function(){return window.sqlitePlugin.openDatabase({name:this.db,location:"default",androidDatabaseImplementation:2,version:1,description:this.db,size:5e6})},t}(o.default);n.default=i},{"./webSqlProvider":6}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("../utils"),o=function(){function e(e,t){this.db=e,this.openDatabase=t}return e.prototype.executeSql=function(e,t){var n=this;return void 0===t&&(t=[]),new Promise(function(r,o){n.openConnection().transaction(function(n){return n.executeSql(e,t||[],function(e,t){return r(t)},function(e,t){return o(t),!0})},function(e){return o(e)})})},e.prototype.batchSql=function(e){var t=this;return new Promise(function(n,o){t.openConnection().transaction(function(t){return r.default.eachAsync(e,function(e,n){t.executeSql(e[0],e[1],function(){return n()},function(e,t){return n(t)})},function(e){return e?o(e):n()})},function(e){return o(e)})})},e.prototype.openConnection=function(){return this.openDatabase?this.openDatabase(this.db):window.openDatabase(this.db,"1","",5e6)},e}();n.default=o},{"../utils":9}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./utils"),o=e("./errors/selectorError"),i=function(){function e(){}return e.query=function(t,n){var r=[];return{where:e.parseObject(t,n,r),args:r}},e.parseObject=function(t,n,r){var i=[];for(var u in t)if(t.hasOwnProperty(u)){var a=t[u];if(["$or","$and"].indexOf(u)>-1&&!Array.isArray(a))throw new o.default("Use of $and, $or operator requires an array as its parameter.");switch(i.length&&i.push(" AND "),u){case"$or":var s=a.map(function(t){return e.parseObject(t,n,r)});s.length&&i.push("("+s.join(" OR ")+")");break;case"$and":s=a.map(function(t){return e.parseObject(t,n,r)}),s.length&&i.push("("+s.join(" AND ")+")");break;default:i.push(e.parseSingleKeyValue(u,a,n,r))}}return i.join("")},e.parseSingleKeyValue=function(t,n,i,u){var a=e.operators[t]||("object"!=typeof n?e.operators.$eq:null);if(a){if("$in"==t||"$nin"==t){if(!Array.isArray(n))throw new o.default("Use of $in, $nin operator requires an array as its parameter.");return u.concat(n),a+" ["+Array(n.length).fill("?").join()+"]"}return null==e.operators[t]&&(a=r.default.wrap(i)+"."+r.default.wrap(t)+" "+a),u.push("string"==typeof n?n.toLowerCase():n),a+" ?"}return r.default.wrap(i)+"."+r.default.wrap(t)+" "+e.parseObject(n,i,u)},e}();i.operators={$eq:"=",$lt:"<",$gt:">",$lte:"<=",$gte:">=",$ne:"!=",$in:"IN",$nin:"NOT IN",$like:"LIKE"},n.default=i},{"./errors/selectorError":4,"./utils":9}],8:[function(e,t,n){"use strict";function r(e){var t=this;return f.instance(t,e)}Object.defineProperty(n,"__esModule",{value:!0});var o=e("./errors/indexNotFoundError"),i=e("./utils"),u=e("./errors/indexExistsError"),a=e("./providers/sqliteProvider"),s=e("./providers/webSqlProvider"),c=e("./queryBuilder"),f=function(){function e(e,t){this.db=e,this.provider=t,this._init=!1,this.indexes={}}return e.prototype.info=function(e){var t=this.indexes[e];return t?Promise.resolve(t):Promise.reject(new o.default(e))},e.prototype.create=function(e){var t=this;if(this.indexes[e.name])return Promise.reject(new u.default(e.name));var n=e.fields.map(function(e){return{name:e.name||e+"",type:e.type||"TEXT"}}),r=[{name:"id",type:"TEXT",primary_key:!0},{name:"rev",type:"TEXT"}].concat(n);return this.createTable("_ri_"+e.name,r).then(function(){return t.provider.executeSql("INSERT INTO "+i.default.wrap("relation-indexes")+" VALUES (?,?,?)",[e.name,e.doc_type,JSON.stringify(n)])}).then(function(){t.indexes[e.name]=Object.assign({},e,{fields:n})})},e.prototype.build=function(e){var t=this,n=this.indexes[e];if(!n)return Promise.reject(new o.default(e));var r=i.default.wrap("_ri_"+e);return this.provider.executeSql("DELETE FROM "+r).then(function(){return t.fillIndexTable(n)})},e.prototype.query=function(e,t,n,r){void 0===r&&(r=!0);var u=this.indexes[e];if(!u)return Promise.reject(new o.default(e));var a,s=i.default.wrap("_ri_"+e),f=t?c.default.query(t,"_ri_"+e):null,l=n&&n.length?n.map(function(e){return s+"."+i.default.wrap(e.field||e+"")+" "+(e.dir||"ASC")}).join():"";if(r)a="\n            SELECT\n                `document-store`.id AS id,\n                `by-sequence`.rev AS rev,\n                `by-sequence`.json AS data \n            FROM `document-store` \n                JOIN `by-sequence` ON `by-sequence`.seq = `document-store`.winningseq \n                JOIN "+s+" ON `document-store`.id = "+s+".id \n            WHERE \n                "+(f.where?f.where+" AND ":"")+" \n                `by-sequence`.deleted = 0 \n            ORDER BY "+(l?l+",":"")+" `document-store`.id ASC";else{a="SELECT "+u.fields.map(function(e){return s+i.default.wrap(e.name)}).join()+" FROM "+s+" WHERE "+(f.where?f.where+" AND ":"")+" 1 = 1 "+(l?"ORDER BY "+l+",":"")}return this.provider.executeSql(a,f.args).then(function(e){for(var t=[],n=0;n<e.rows.length;n++){var r=e.rows.item(n);t.push(i.default.unstringifyDoc(r.data,r.id,r.rev))}return t})},e.prototype.remove=function(e){var t=this;if(!this.indexes[e])return Promise.reject(new o.default(e));var n=i.default.wrap("_ri_"+e);return this.provider.executeSql("DELETE FROM "+i.default.wrap("relation-indexes")+" WHERE index_name = ?",[e]).then(function(){return t.provider.executeSql("DROP TABLE IF EXISTS "+n)}).then(function(){delete t.indexes[e]})},e.prototype.update=function(e){var t=this,n=this.indexes[e];if(!n)return Promise.reject(new o.default(e));var r=i.default.wrap("_ri_"+e),u=n.doc_type.length,a=["_id","_rev"].concat(n.fields.map(function(e){return e.name})),s=Array(a.length).fill("?"),c="\n        SELECT \n            `document-store`.id AS id, \n            `by-sequence`.rev AS rev, \n            `by-sequence`.json AS data \n        FROM `document-store` \n            JOIN `by-sequence` ON `by-sequence`.seq = `document-store`.winningseq  \n        WHERE \n            NOT EXISTS(SELECT 1 FROM "+r+" WHERE `document-store`.id like "+r+".id )  \n            AND \n            substr(`document-store`.id, 1, "+u+") = ?  \n            AND \n            `by-sequence`.deleted = 0";return this.provider.executeSql(c,[n.doc_type]).then(function(e){for(var n=[],o=0;o<e.rows.length;o++){var u=e.rows.item(o);n.push(i.default.unstringifyDoc(u.data,u.id,u.rev))}if(n.length){var c=n.map(function(e){var t=a.map(function(t){var n=i.default.resolve(e,t);return"string"==typeof n?n.toLowerCase():n});return["INSERT INTO "+r+" VALUES ("+s+")",t]});return t.provider.batchSql(c)}})},e.prototype.init=function(){var e=this;return this._init?Promise.resolve(null):this.createTable("relation-indexes",[{name:"index_name",type:"TEXT"},{name:"doc_type",type:"TEXT"},{name:"json",type:"TEXT"}]).then(function(){return e.getIndexes()}).then(function(){e._init=!0})},e.prototype.getIndexes=function(){var e=this;return this.provider.executeSql("SELECT * FROM "+i.default.wrap("relation-indexes")).then(function(t){for(var n=0;n<t.rows.length;n++){var r=t.rows.item(n);e.indexes[r.index_name]={name:r.index_name,doc_type:r.doc_type,fields:JSON.parse(r.json)}}})},e.prototype.createTable=function(e,t){return this.provider.executeSql("CREATE TABLE IF NOT EXISTS "+i.default.wrap(e)+" ("+i.default.fieldsToSql(t)+")").then(function(){})},e.prototype.fillIndexTable=function(e,t){var n=this;void 0===t&&(t=0);var r=i.default.wrap("_ri_"+e.name),o=["_id","_rev"].concat(e.fields.map(function(e){return e.name})),u=Array(o.length).fill("?");return this.db.allDocs({startkey:e.doc_type,endkey:e.doc_type+"ï¿¿",include_docs:!0,skip:t,limit:1e3}).then(function(a){var s=a.rows.length;if(s){var c=a.rows.map(function(e){var t=o.map(function(t){var n=i.default.resolve(e.doc,t);return"string"==typeof n?n.toLowerCase():n});return["INSERT INTO "+r+" VALUES ("+u+")",t]});return n.provider.batchSql(c).then(function(){if(1e3===s)return n.fillIndexTable(e,t+1e3)})}})},e.instance=function(t,n){if(t.relIndex)return Promise.resolve(null);var r;if("cordova-sqlite"===t.adapter&&window.sqlitePlugin)r=new a.default(t.name);else{if("websql"!==t.adapter)throw new Error("Relation Index plugin supports only websql or cordova-sqlite adapters");r=new s.default(t.prefix+t.name,n)}return t.relIndex=new e(t,r),t.relIndex.init()},e}();n.RelationIndex=f,n.initRelationIndex=r,"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin({initRelationIndex:r})},{"./errors/indexExistsError":2,"./errors/indexNotFoundError":3,"./providers/sqliteProvider":5,"./providers/webSqlProvider":6,"./queryBuilder":7,"./utils":9}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("vuvuzela"),o=function(){function e(){}return e.wrap=function(e){return Array.isArray(e)?e.map(function(e){return"`"+e+"`"}).join():"`"+e+"`"},e.fieldsToSql=function(t){return t.map(function(t){return e.wrap(t.name)+" "+t.type+" "+(t.primary_key?"NOT NULL PRIMARY KEY":"")}).join()},e.resolve=function(e,t,n){return void 0===n&&(n=null),t.split(".").reduce(function(e,t){return e&&e[t]},e)||n},e.eachAsync=function(e,t,n){var r=0,o=e.length,i=function(u){!u&&r<o?(t(e[r],i),r++):"function"==typeof n&&n(u)};i()},e.unstringifyDoc=function(t,n,r){return t=e.safeJsonParse(t),t._id=n,t._rev=r,t},e.safeJsonParse=function(e){try{return JSON.parse(e)}catch(t){return r.default.parse(e)}},e}();n.default=o},{vuvuzela:1}]},{},[8])(8)});
